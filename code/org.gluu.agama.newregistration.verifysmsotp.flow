// Start subflow for user otp code validation
Flow org.gluu.agama.newregistration.verifysmsotp
     Basepath ""
     Timeout 900 seconds
     Inputs userRegistrationService phone lang
// Log flow imputs provided by the flow caller.
Log "@info Information received from the caller: " phone lang
otpUiFeedback = {}
resendCount = 0
validationAttempts = 0
maxSMS = Repeat 20 times max
     //  Show UI to collect OTP code from user.
     otpCreds = RRF "smsOtp.ftlh" otpUiFeedback
     When otpCreds.changenumber is "yes"
          it_ibtew = {success:false, error: "Your error message here"}
          Finish it_ibtew
     Otherwise
          When otpCreds.hasRequestedNewCode is "yes"
               // Log new code request
               Log "@info User has requested a new code."
               When resendCount is 3
                    Log "@ " __________
                    Finish __________
               resendCount = Call org.gluu.agama.newregistaration.CounterHelper#increment resendCount
               Log "@info Resend attempt number: " resendCount
               // Resend otp
               resendHasSucceed = Call userRegistrationService sendOTPCode phone lang
               When 
                    Log "@ " __________
               Log "@ " __________
          Otherwise
               //  Add log entry with collected code in log file.
               Log "@info Information provided by the user is : " otpCreds.code
               // validationAttempts
               validationAttempts = Call org.gluu.agama.newregistaration.CounterHelper#increment validationAttempts
               // Add log entry withvalidation result in log file.
               Log "@info Validation attempt number: " validationAttempts
               // Check validation
               When validationAttempts is 4
                    // Log validation exceeded
                    Log "@info Maximum validation attempts exceeded"
                    it_otpmax = { success: false, error: "ExceededTheNumberOfAttemptsAllowed" }
                    Finish it_otpmax
               Otherwise
                    //  Validate the OTP code provided by the user.
                    otpValidationResult = Call validationAttempts validateOTPCode phone otpCreds.code
                    // Add log entry withvalidation result in log file.
                    Log "@info OTP validation result is:" otpValidationResult
                    // If otp validation was successful
                    When otpValidationResult is true
                         Log "@info OTP validated Successfully"
                         Finish otpValidationResult
                    Otherwise
                         // The maximum number of attempt has been reached.
                         Log "@info Invalid code provided "
                         // Provide feedback to user.
                         otpUiFeedback.errorMessage = "Invalid code provided."
                         otpUiFeedback.infoMessage = ""
// "OTP verification loop completed"
Log "@info OTP verification loop completed"
it_loopmax = { success: false, error: "UnexpectedLoopCompletion" }
// SMS OTP error
Finish it_loopmax